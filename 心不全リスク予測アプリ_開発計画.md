# 心不全リスク予測アプリ 開発計画

## 1. アプリ概要

### 1.1 目的
- 東京の気象データを自動取得
- 心不全リスクをリアルタイムで予測
- ユーザーフレンドリーなインターフェース
- 医療関係者向けの実用的なツール

### 1.2 主要機能
- **リアルタイム気象データ取得**: 気象庁APIから自動取得
- **心不全リスク予測**: 保存済みモデルを使用
- **リスクレベル表示**: 視覚的に分かりやすい表示
- **履歴表示**: 過去のリスク推移
- **アラート機能**: 高リスク日の通知

## 2. 技術スタック

### 2.1 バックエンド
- **Python**: メイン言語
- **FastAPI**: Web APIフレームワーク
- **SQLite/PostgreSQL**: データベース
- **Celery**: 非同期タスク（気象データ取得）
- **Redis**: キャッシュ・メッセージキュー

### 2.2 フロントエンド
- **React/Vue.js**: モダンなUI
- **Chart.js/D3.js**: グラフ表示
- **Bootstrap/Tailwind CSS**: レスポンシブデザイン

### 2.3 インフラ
- **Docker**: コンテナ化
- **AWS/GCP**: クラウドデプロイ
- **GitHub Actions**: CI/CD

## 3. システム構成

### 3.1 データフロー
```
気象庁API → データ処理 → モデル予測 → Web API → フロントエンド
```

### 3.2 コンポーネント構成
```
├── data_collector/     # 気象データ収集
├── model_service/      # 予測モデル
├── api_server/         # FastAPIサーバー
├── frontend/           # Reactアプリ
└── database/           # データベース
```

## 4. 実装手順

### 4.1 Phase 1: データ収集システム
- 気象庁APIの実装
- データベース設計
- 自動取得スケジューラー

### 4.2 Phase 2: 予測API
- 保存済みモデルの読み込み
- FastAPIエンドポイント
- 予測結果のキャッシュ

### 4.3 Phase 3: フロントエンド
- Reactアプリ開発
- リアルタイム更新
- レスポンシブデザイン

### 4.4 Phase 4: デプロイ
- Docker化
- クラウドデプロイ
- 監視・ログ

## 5. 具体的な実装例

### 5.1 気象データ取得
```python
import requests
import pandas as pd
from datetime import datetime

def fetch_weather_data():
    """気象庁APIから東京の気象データを取得"""
    # 気象庁APIエンドポイント
    url = "https://www.jma.go.jp/bosai/amedas/data/point/44132/today.json"
    
    response = requests.get(url)
    data = response.json()
    
    # データ処理
    weather_data = {
        'date': datetime.now().date(),
        'avg_temp': data['temp']['mean'],
        'max_temp': data['temp']['max'],
        'min_temp': data['temp']['min'],
        'avg_humidity': data['humidity']['mean'],
        'pressure': data['pressure']['mean'],
        'precipitation': data['precipitation']['total']
    }
    
    return weather_data
```

### 5.2 予測API
```python
from fastapi import FastAPI
import joblib
import numpy as np

app = FastAPI()

# 保存済みモデルを読み込み
model = joblib.load('心不全気象予測モデル_50回Fold最適化版_保存モデル/prediction_pipeline.py')

@app.post("/predict")
async def predict_risk(weather_data: dict):
    """心不全リスクを予測"""
    # 特徴量エンジニアリング
    features = create_features(weather_data)
    
    # 予測実行
    risk_probability = model.predict_proba([features])[0][1]
    
    # リスクレベル判定
    risk_level = "低リスク" if risk_probability < 0.3 else "中リスク" if risk_probability < 0.7 else "高リスク"
    
    return {
        "risk_probability": risk_probability,
        "risk_level": risk_level,
        "prediction_date": datetime.now().isoformat()
    }
```

### 5.3 フロントエンド（React）
```javascript
import React, { useState, useEffect } from 'react';
import axios from 'axios';

function HeartFailureRiskApp() {
  const [riskData, setRiskData] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetchRiskData();
    // 1時間ごとに更新
    const interval = setInterval(fetchRiskData, 3600000);
    return () => clearInterval(interval);
  }, []);

  const fetchRiskData = async () => {
    try {
      const response = await axios.get('/api/predict');
      setRiskData(response.data);
    } catch (error) {
      console.error('Error fetching risk data:', error);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="app">
      <h1>心不全リスク予測</h1>
      {loading ? (
        <div>読み込み中...</div>
      ) : (
        <div className="risk-display">
          <div className={`risk-level ${riskData.risk_level}`}>
            {riskData.risk_level}
          </div>
          <div className="risk-probability">
            リスク確率: {(riskData.risk_probability * 100).toFixed(1)}%
          </div>
        </div>
      )}
    </div>
  );
}
```

## 6. デプロイ構成

### 6.1 Docker Compose
```yaml
version: '3.8'
services:
  api:
    build: ./api_server
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=postgresql://user:pass@db:5432/heartfailure
    depends_on:
      - db
      - redis

  frontend:
    build: ./frontend
    ports:
      - "3000:3000"
    depends_on:
      - api

  db:
    image: postgres:13
    environment:
      - POSTGRES_DB=heartfailure
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=pass

  redis:
    image: redis:6
```

## 7. セキュリティ・監視

### 7.1 セキュリティ
- API認証（JWT）
- HTTPS強制
- レート制限
- 入力値検証

### 7.2 監視
- アプリケーションログ
- パフォーマンス監視
- エラー通知
- データベース監視

## 8. 今後の拡張

### 8.1 機能拡張
- 複数地域対応
- 他の疾患（AMI、脳卒中）の追加
- モバイルアプリ版
- プッシュ通知

### 8.2 技術拡張
- 機械学習モデルの自動更新
- リアルタイム予測の精度向上
- 大規模データ処理
- AI/MLパイプライン

---

**開発期間**: 3-6ヶ月
**チーム構成**: バックエンド1名、フロントエンド1名、MLエンジニア1名
**予算**: 開発費 + クラウド運用費 