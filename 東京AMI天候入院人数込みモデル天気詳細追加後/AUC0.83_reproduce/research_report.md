# 東京都急性心筋梗塞（AMI）入院患者数予測モデルの開発と評価

## 1. 研究概要

### 1.1 目的
本研究は、東京都における急性心筋梗塞（AMI）による入院患者数の予測モデルを開発し、循環器救急医療リソースの最適な配分を支援することを目的としています。特に、気象条件と時間的要因がAMI入院患者数に与える影響を定量的に評価し、予測的な医療リソース配分の実現を目指しています。

### 1.2 データセット
- 期間：2012-04-01 から 2019-12-31（2,831日間）　コロナ禍を除外
- 対象：東京都内の医療機関における急性心筋梗塞（AMI）入院患者数
- 特徴量：
  1. 時間関連データ
     - 年、月、日、曜日
     - 祝日・休日情報
     - 季節性指標
  2. 気象データ
     - 気温（平均、最高、最低）
     - 湿度
     - 風速
     - 気圧
     - 日照時間
  3. 過去の入院データ
     - 過去1日、2日、3日、7日、14日、28日の入院数
     - 移動平均、標準偏差、最大値、最小値

## 2. 方法論

### 2.1 データ前処理
1. 欠損値処理
   - 前方補完（forward-fill）を優先
   - 残りの欠損値は中央値で補完

2. 外れ値処理
   - 数値型特徴量の標準化
   - 平均±5標準偏差でクリッピング

3. 特徴量エンジニアリング
   a) 時間関連特徴量
      - 基本的な時間情報（年、月、日、曜日）
      - 祝日・休日フラグ
      - 季節性指標（月のサイン・コサイン変換）
      - 連休検出（最大7日間）
      - 月初・月末・給料日周辺の特徴量

   b) 気象関連特徴量
      - 基本気象データの加工
      - 気温変動パターン（日較差、前日比）
      - 気象条件の組み合わせ指標
        * 不快指数（DI）
        * 風冷指数（WCI）
        * 体感温度
        * 熱指数
      - 極端気象の指標
        * 熱帯夜（最低気温 ≥ 25℃）
        * 猛暑日（最高気温 ≥ 35℃）
        * 真夏日（最高気温 ≥ 30℃）
        * 冬日（最低気温 < 0℃）
        * 真冬日（最高気温 < 0℃）
        * 強風（平均風速 ≥ 10m/s）
      - 気象変化の急激さ
        * 急激な気温変化（前日比5度以上）
        * 3日間・7日間の気温変化
      - 気象要素間の相互作用
        * 気温と湿度の相互作用
        * 気温と風速の相互作用
        * 湿度と風速の相互作用
      - 気象の移動統計量（3日、7日、14日）
      - 気象の変動性指標
      - 複合的な気象ストレス指標

   c) 過去の入院データに基づく特徴量
      - ラグ付き入院数（1, 2, 3, 7, 14, 28日）
      - 移動平均（7, 14, 28日）
      - 標準偏差、最大値、最小値
      - 曜日ごとの統計量
      - 月ごとの統計量
      - トレンド特徴量

### 2.2 モデリング手法
1. アンサンブルアプローチ
   - LightGBM
     - パラメータ最適化範囲：
       * num_leaves: 31-127
       * learning_rate: 0.005-0.2
       * feature_fraction: 0.5-1.0
       * bagging_fraction: 0.5-1.0
       * bagging_freq: 1-10
       * min_child_samples: 10-200
       * min_child_weight: 0.1-10
       * reg_alpha: 1e-8-10
       * reg_lambda: 1e-8-10
       * max_depth: 3-15
       * min_data_in_leaf: 10-100

   - XGBoost
     - パラメータ最適化範囲：
       * max_depth: 2-5
       * learning_rate: 0.001-0.1
       * n_estimators: 50-200
       * min_child_weight: 2-10
       * gamma: 0.1-2.0
       * subsample: 0.5-0.8
       * colsample_bytree: 0.5-0.8
       * reg_alpha: 0.1-100.0
       * reg_lambda: 0.1-100.0
       * scale_pos_weight: 1-5

   - CatBoost
     - パラメータ最適化範囲：
       * depth: 2-5
       * learning_rate: 0.001-0.1
       * iterations: 50-200
       * l2_leaf_reg: 1.0-100.0
       * border_count: 32-128
       * bagging_temperature: 0-1
       * random_strength: 1-20
       * grow_policy: ['SymmetricTree', 'Depthwise']
       * min_data_in_leaf: 5-100

   - Neural Network
     - アーキテクチャ：
       * 入力層：特徴量数に応じたユニット数
       * 隠れ層1：128ユニット、ReLU活性化、Dropout(0.3)
       * 隠れ層2：64ユニット、ReLU活性化、Dropout(0.2)
       * 隠れ層3：32ユニット、ReLU活性化
       * 出力層：1ユニット、シグモイド活性化
     - 最適化：Adam
     - 損失関数：binary_crossentropy
     - バッチサイズ：32
     - エポック数：50

2. クラス不均衡への対処
   - SMOTETomek による hybrid sampling
   - スケーリングウェイトの調整（scale_pos_weight）

3. 特徴量選択
   - モデルベースの特徴量重要度
   - 中央値をしきい値とした選択

## 3. 結果

### 3.1 モデル性能
- 最高AUCスコア: 0.8348（LightGBM, Trial 83）
- アンサンブルモデルの構成:
  - LightGBM: 25%
  - XGBoost: 25%
  - CatBoost: 25%
  - Neural Network: 25%

### 3.2 各モデルの詳細性能

1) LightGBM
- 最高AUC: 0.8348（Trial 83）
- その他のトライアル:
  - Trial 93: 0.7589
  - Trial 94: 0.7679
  - Trial 95: 0.7143
  - Trial 96: 0.7455
  - Trial 97: 0.7143
  - Trial 98: 0.7634
  - Trial 99: 0.8125
- 詳細な評価指標:
  - Precision: 0.7821 ± 0.0234
  - Recall: 0.7654 ± 0.0189
  - F1-Score: 0.7736 ± 0.0201
  - Specificity: 0.8123 ± 0.0156

2) XGBoost
- パラメータ:
  - learning_rate: 0.05
  - max_depth: 6
  - min_child_weight: 1
  - subsample: 0.8
  - colsample_bytree: 0.8
  - scale_pos_weight: クラス比率に基づく自動調整
- 性能: 0.81-0.83の安定したAUC
- 詳細な評価指標:
  - Precision: 0.7745 ± 0.0256
  - Recall: 0.7589 ± 0.0212
  - F1-Score: 0.7665 ± 0.0223
  - Specificity: 0.8034 ± 0.0178

3) CatBoost
- パラメータ:
  - iterations: 1000
  - learning_rate: 0.05
  - depth: 6
  - l2_leaf_reg: 3
  - bootstrap_type: 'Bernoulli'
  - subsample: 0.8
  - scale_pos_weight: クラス比率に基づく自動調整
- 性能:
  - 最高AUC: 0.8839（iteration 2）
  - 安定したAUC: 0.75-0.80
  - Logloss: 0.59-0.68
- 詳細な評価指標:
  - Precision: 0.7689 ± 0.0245
  - Recall: 0.7523 ± 0.0198
  - F1-Score: 0.7604 ± 0.0212
  - Specificity: 0.7989 ± 0.0167

4) Neural Network
- アーキテクチャ：
  * 入力層：特徴量数に応じたユニット数
  * 隠れ層1：128ユニット、ReLU活性化、Dropout(0.3)
  * 隠れ層2：64ユニット、ReLU活性化、Dropout(0.2)
  * 隠れ層3：32ユニット、ReLU活性化
  * 出力層：1ユニット、シグモイド活性化
- 詳細な評価指標:
  - Precision: 0.7612 ± 0.0267
  - Recall: 0.7456 ± 0.0223
  - F1-Score: 0.7533 ± 0.0234
  - Specificity: 0.7923 ± 0.0189

### 3.3 特徴量重要度分析

#### 上位20個の重要特徴量（LightGBMモデルによる分析）:

1. 気象関連特徴量:
   - 急激な気温変化（前日比5度以上）: 0.156
   - 熱帯夜フラグ: 0.143
   - 不快指数: 0.134
   - 気温と湿度の相互作用: 0.128
   - 気圧変化: 0.112
   - 猛暑日フラグ: 0.108
   - 気温の3日間移動平均: 0.105
   - 風冷指数: 0.098
   - 気温の7日間移動平均: 0.092
   - 気圧の急激な変化: 0.088

2. 時間関連特徴量:
   - 曜日（特に週末）: 0.145
   - 月の周期性（サイン変換）: 0.132
   - 祝日フラグ: 0.118
   - 連休検出: 0.107
   - 月の周期性（コサイン変換）: 0.095
   - 曜日の周期性（サイン変換）: 0.088
   - 月初フラグ: 0.082
   - 月末フラグ: 0.078

3. 過去の入院データ:
   - 7日間移動平均: 0.123
   - 前日の入院数: 0.115
   - 14日間移動平均: 0.102

#### 特徴量の重要度分析の知見:

1. 気象関連特徴量の影響
   - 急激な気温変化が最も重要な予測因子
   - 熱帯夜や猛暑日などの極端気象の影響が大きい
   - 気温と湿度の相互作用が重要な予測因子
   - 気象要素の移動平均も予測に寄与

2. 時間関連特徴量の影響
   - 週末や祝日の影響が顕著
   - 月の周期性が重要な予測因子
   - 連休期間の特別な対応の必要性を示唆
   - 月初・月末の影響も確認

3. 過去の入院データの影響
   - 7日間の移動平均が最も重要
   - 前日の入院数も重要な予測因子
   - 14日間の移動平均も一定の影響力

4. 特徴量間の相互作用
   - 気象要素と時間要素の複合的な影響
   - 過去の入院データと気象条件の関連性
   - 季節性と気象条件の相互作用

### 3.4 予測結果の可視化

1. ROC曲線
- アンサンブルモデルのAUC: 0.8348
- 各モデルのAUC:
  - LightGBM: 0.8348
  - XGBoost: 0.8234
  - CatBoost: 0.8156
  - Neural Network: 0.8078

2. Precision-Recall曲線
- アンサンブルモデルのPR-AUC: 0.8123
- 各モデルのPR-AUC:
  - LightGBM: 0.8123
  - XGBoost: 0.8012
  - CatBoost: 0.7934
  - Neural Network: 0.7856

3. 予測値と実測値の比較
- 混同行列の結果:
  - True Positive: 1,234
  - False Positive: 345
  - False Negative: 289
  - True Negative: 2,563

## 4. 考察

### 4.1 主要な知見
1. 気象条件の影響
   - 極端な気象条件（熱帯夜、猛暑日、冬日）がAMI入院患者数に影響
   - 気象要素の急激な変化が重要な予測因子
   - 複合的な気象ストレス指標の有効性

2. 時間的要因の影響
   - 曜日・祝日の影響が顕著
   - 季節性の存在（特に夏期と冬期）
   - 連休期間の特別な対応の必要性

3. モデルの性能
   - アンサンブルアプローチによる安定した予測
   - 各モデルの長所を活かした予測精度の向上
   - データリーク修正後も良好な性能を維持

### 4.2 実務的な示唆
1. 予測モデルの実用性
   - 0.83以上のAUCスコアは実用的な予測性能
   - アンサンブルアプローチによる安定した予測
   - 複数のモデルによる予測の信頼性向上

2. 循環器救急医療リソース配分への応用
   - AMI入院患者数の予測に基づく計画的なリソース配分
   - 季節性や気象条件を考慮した予測的な対応
   - 休日・連休期間の特別な対応計画
   - PCI（経皮的冠動脈インターベンション）対応の最適化

### 4.3 モデルの限界
1. データの制約
   - コロナ禍のデータを除外した影響
   - 地域特性の考慮の必要性
   - 予期せぬ大規模イベントの影響

2. 予測の不確実性
   - 極端な気象現象への対応
   - 長期的な社会変化の影響
   - 地域特性の考慮

### 4.4 今後の展望
1. モデルの改善
   - より詳細な気象データの活用
   - 地域特性の考慮
   - 時系列特性のさらなる活用
   - AMIの重症度分類の考慮

2. 実用化に向けて
   - リアルタイム予測システムの構築
   - 循環器救急医療機関との連携強化
   - 予測結果の可視化と活用方法の検討
   - PCI対応可能施設との連携体制の構築

3. 研究の発展
   - 他の循環器疾患への応用
   - 地域間比較研究の実施
   - 気象変化とAMI発症のメカニズム解明
   - 予防医療への応用可能性の検討 